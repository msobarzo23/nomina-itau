<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>NÃ³mina ItaÃº â€“ TXT</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Mono:wght@400;500&display=swap');

  :root {
    --bg:      #0b0c10;
    --surface: #13141a;
    --border:  #22243a;
    --accent:  #f5a623;
    --blue:    #003087;
    --text:    #e6e6f0;
    --muted:   #5c5e78;
    --ok:      #22c55e;
    --err:     #ef4444;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    padding: 1.8rem 1rem 3rem;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .wrap { max-width: 620px; width: 100%; }

  header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.8rem; }

  .badge {
    background: var(--blue);
    color: var(--accent);
    font-family: 'DM Serif Display', serif;
    font-size: 1rem;
    padding: 0.3rem 0.8rem;
    border-radius: 6px;
    letter-spacing: 1px;
    flex-shrink: 0;
  }

  h1 { font-family: 'DM Serif Display', serif; font-size: 1.45rem; line-height: 1.2; }
  h1 em { color: var(--accent); font-style: normal; }

  .subtitle { font-size: 0.68rem; color: var(--muted); margin-top: 0.2rem; letter-spacing: .5px; }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.3rem;
    margin-bottom: 0.9rem;
  }

  .card-title {
    font-size: 0.6rem;
    letter-spacing: 2px;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 1rem;
  }

  .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 0.7rem; }
  .field { display: flex; flex-direction: column; gap: 0.25rem; }

  label { font-size: 0.62rem; letter-spacing: 1.5px; color: var(--muted); text-transform: uppercase; }

  input[type=text], select {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 7px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.82rem;
    padding: 0.55rem 0.8rem;
    outline: none;
    width: 100%;
    transition: border-color .18s;
    -webkit-appearance: none;
    appearance: none;
  }
  input[type=text]:focus, select:focus { border-color: var(--accent); }

  select option { background: #1a1b25; }

  /* Drop zone */
  .drop {
    border: 2px dashed var(--border);
    border-radius: 10px;
    padding: 2rem 1rem;
    text-align: center;
    cursor: pointer;
    position: relative;
    transition: all .2s;
  }
  .drop.over, .drop:hover { border-color: var(--accent); background: rgba(245,166,35,.04); }
  .drop input { position: absolute; inset: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; font-size: 0; }
  .drop-icon { font-size: 1.8rem; display: block; margin-bottom: 0.6rem; }
  .drop-hint { font-size: 0.75rem; color: var(--muted); line-height: 1.6; }
  .drop-hint strong { color: var(--accent); display: block; font-size: 0.9rem; margin-bottom: 0.2rem; }

  /* Status */
  .status { font-size: 0.72rem; padding: 0.55rem 0.9rem; border-radius: 8px; margin-top: 0.7rem; line-height: 1.5; display: none; }
  .status.info { display:block; background:rgba(245,166,35,.08); color:var(--accent); border:1px solid rgba(245,166,35,.25); }
  .status.ok   { display:block; background:rgba(34,197,94,.08);  color:var(--ok);    border:1px solid rgba(34,197,94,.25); }
  .status.err  { display:block; background:rgba(239,68,68,.08);  color:var(--err);   border:1px solid rgba(239,68,68,.25); }

  .warnings { margin-top: 0.6rem; font-size: 0.68rem; color: #f59e0b; line-height: 1.8; display: none; background: rgba(245,158,11,.06); border: 1px solid rgba(245,158,11,.2); border-radius: 8px; padding: 0.6rem 0.9rem; }

  /* Stats */
  .stats { display: none; grid-template-columns: repeat(3,1fr); gap: 0.5rem; margin-top: 0.8rem; }
  .stat { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.6rem; text-align: center; }
  .stat-val { font-family: 'DM Serif Display', serif; font-size: 1.1rem; color: var(--accent); }
  .stat-lbl { font-size: 0.58rem; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-top: 0.1rem; }

  /* Preview table */
  .prev-wrap { overflow-x: auto; margin-top: 0.9rem; border: 1px solid var(--border); border-radius: 8px; display: none; }
  table { width: 100%; border-collapse: collapse; font-size: 0.67rem; }
  th { background: #161828; color: var(--accent); padding: 0.45rem 0.6rem; text-align: left; font-size: 0.58rem; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap; }
  td { padding: 0.4rem 0.6rem; border-top: 1px solid var(--border); white-space: nowrap; max-width: 140px; overflow: hidden; text-overflow: ellipsis; }
  tr:hover td { background: rgba(255,255,255,.02); }
  .tag-ok  { color: var(--ok); }
  .tag-fix { color: var(--accent); }

  /* TXT preview */
  .txt-prev {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.8rem;
    font-size: 0.58rem;
    color: var(--ok);
    overflow-x: auto;
    white-space: pre;
    margin-top: 0.9rem;
    display: none;
    line-height: 1.6;
    max-height: 140px;
    overflow-y: auto;
  }

  /* Button */
  .btn {
    display: none;
    width: 100%;
    margin-top: 0.8rem;
    padding: 0.9rem;
    background: var(--accent);
    color: #0b0c10;
    font-family: 'DM Mono', monospace;
    font-size: 0.82rem;
    font-weight: 500;
    letter-spacing: 1px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all .18s;
    -webkit-appearance: none;
  }
  .btn:hover:not(:disabled) { background: #ffc040; transform: translateY(-1px); }
  .btn:disabled { opacity: .4; cursor: not-allowed; }

  footer { margin-top: 2rem; font-size: 0.62rem; color: var(--muted); text-align: center; letter-spacing: 1px; line-height: 2.2; }
  .pill { display:inline-block; background:rgba(245,166,35,.12); color:var(--accent); font-size:0.58rem; padding:.12rem .5rem; border-radius:20px; letter-spacing:1px; }

  /* Info tooltip */
  .info-row { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.6rem; }
  .info-tag { font-size: 0.6rem; color: var(--muted); background: rgba(255,255,255,.04); border: 1px solid var(--border); border-radius: 5px; padding: 0.2rem 0.5rem; }
  .info-tag span { color: var(--accent); }
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="badge">ITAÃš</div>
    <div>
      <h1>Procesador de <em>NÃ³mina</em></h1>
      <div class="subtitle">Genera el archivo TXT oficial para carga en portal banco</div>
    </div>
  </header>

  <!-- â”€â”€ Config empresa â”€â”€ -->
  <div class="card">
    <div class="card-title">âš™ Datos fijos de tu empresa</div>
    <div style="display:flex;flex-direction:column;gap:.7rem">
      <div class="grid2">
        <div class="field">
          <label>RUT Empresa</label>
          <input type="text" id="rutEmpresa" value="883971000" placeholder="Sin puntos ni guiÃ³n">
        </div>
        <div class="field">
          <label>NÂ° Cuenta Cargo</label>
          <input type="text" id="cuentaCargo" value="206388064">
        </div>
      </div>
      <div class="grid2">
        <div class="field">
          <label>Tipo de Servicio</label>
          <select id="tipoServicio">
            <option value="006001">006001 â€“ Pago de Sueldos</option>
            <option value="006002">006002 â€“ Pago de Anticipos</option>
            <option value="006003">006003 â€“ Pago de Honorarios</option>
            <option value="005003">005003 â€“ Pago de Proveedores</option>
            <option value="007001">007001 â€“ Transferencias TEF</option>
          </select>
        </div>
        <div class="field">
          <label>DescripciÃ³n cabecera</label>
          <input type="text" id="descripcion" value="PAGO NOMINA" placeholder="MÃ¡x 40 caracteres">
        </div>
      </div>
      <div class="grid2">
        <div class="field">
          <label>Glosa Cuenta Origen</label>
          <input type="text" id="glosaOrig" value="nomina" placeholder="MÃ¡x 20 chars">
        </div>
        <div class="field">
          <label>Glosa Cuenta Destino</label>
          <input type="text" id="glosaDesc" value="nomina" placeholder="MÃ¡x 20 chars">
        </div>
      </div>
    </div>
    <div class="info-row">
      <div class="info-tag">MedioRespaldo fijo: <span>CAT_CSH_CONTRACT_ACCOUNT</span></div>
      <div class="info-tag">Cuenta cargo tipo: <span>CAT_CSH_CCTE</span></div>
    </div>
  </div>

  <!-- â”€â”€ Upload â”€â”€ -->
  <div class="card">
    <div class="card-title">ðŸ“‚ Archivo de Recursos Humanos</div>

    <div class="drop" id="drop">
      <input type="file" id="fileIn" accept=".xlsx,.xlsm,.xls,.csv">
      <span class="drop-icon">ðŸ“‹</span>
      <div class="drop-hint">
        <strong>Toca para seleccionar el archivo de RRHH</strong>
        xlsx, xlsm, xls o csv Â· detecta automÃ¡ticamente la fila de datos<br>
        <small style="color:#3d3f5a;margin-top:.3rem;display:block">âš  Si el archivo tiene una fila de TOTALES al final, serÃ¡ excluida automÃ¡ticamente</small>
      </div>
    </div>

    <div class="status" id="status"></div>
    <div class="warnings" id="warnings"></div>

    <div class="stats" id="statsBox">
      <div class="stat"><div class="stat-val" id="sRows">0</div><div class="stat-lbl">Pagos</div></div>
      <div class="stat"><div class="stat-val" id="sTotal">$0</div><div class="stat-lbl">Monto Total</div></div>
      <div class="stat"><div class="stat-val" id="sFix">0</div><div class="stat-lbl">Corregidos</div></div>
    </div>

    <div class="prev-wrap" id="prevWrap">
      <table id="prevTable"></table>
    </div>

    <!-- Vista previa del TXT -->
    <div class="txt-prev" id="txtPrev"></div>

    <button class="btn" id="genBtn" onclick="generar()">â¬‡ GENERAR ARCHIVO TXT PARA BANCO</button>
  </div>

  <footer>
    <span class="pill">ðŸ“± FUNCIONA EN IPHONE Â· SIN INSTALACIÃ“N</span><br>
    Los datos nunca salen de tu dispositivo Â· formato oficial ItaÃº On-line
  </footer>

</div>

<script>
// â”€â”€â”€ Estado â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let filas = [];

// â”€â”€â”€ Drag & drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const drop = document.getElementById('drop');
drop.addEventListener('dragover',  e => { e.preventDefault(); drop.classList.add('over'); });
drop.addEventListener('dragleave', () => drop.classList.remove('over'));
drop.addEventListener('drop', e => { e.preventDefault(); drop.classList.remove('over'); leer(e.dataTransfer.files[0]); });
document.getElementById('fileIn').addEventListener('change', e => leer(e.target.files[0]));

// â”€â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function st(msg, tipo) {
  const el = document.getElementById('status');
  el.textContent = msg;
  el.className = 'status ' + tipo;
}

// â”€â”€â”€ Tablas de conversiÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Tipo de cuenta RRHH â†’ cÃ³digo TXT banco
function tipoCuentaCodigo(v) {
  if (!v) return '';
  const s = v.toString().trim().toLowerCase();
  if (s.includes('corriente')) return 'CAT_CSH_CCTE';
  if (s.includes('vista'))     return 'CAT_CSH_CVIS';
  if (s.includes('ahorro'))    return 'CAT_CSH_CINT';
  // Si ya viene el cÃ³digo correcto
  if (v.toString().trim().startsWith('CAT_')) return v.toString().trim();
  return '';
}

// Nombre legible para preview
function tipoCuentaNombre(cod) {
  const m = { 'CAT_CSH_CCTE':'Cta Corriente', 'CAT_CSH_CVIS':'Cta Vista', 'CAT_CSH_CINT':'Cta Intereses' };
  return m[cod] || cod;
}

// MÃ©todo de pago: el archivo de RRHH trae "Abono en Cuenta" â†’ CAT_CSH_TRANSFER
function metodoPago(v) {
  if (!v) return 'CAT_CSH_TRANSFER';
  const s = v.toString().trim().toLowerCase();
  if (s.includes('abono') || s.includes('transfer')) return 'CAT_CSH_TRANSFER';
  if (s.includes('vale vista virtual'))  return 'CAT_CSH_VIRTUAL_OFFICE_CHECK';
  if (s.includes('vale vista impreso'))  return 'CAT_CSH_PRINTED_OFFICE_CHECK';
  if (s.includes('orden'))               return 'CAT_CSH_PAYMENT_ORDER';
  return 'CAT_CSH_TRANSFER';
}

// CÃ³digo banco: si viene nÃºmero usarlo; si es ItaÃº â†’ 039
function codigoBanco(v) {
  if (!v && v !== 0) return '';
  const s = v.toString().trim();
  // Si ya es numÃ©rico
  if (/^\d+$/.test(s)) return s.padStart(3, '0');
  // Texto
  const t = s.toLowerCase();
  if (t.includes('itaÃº') || t.includes('itau')) return '039';
  if (t.includes('santander')) return '037';
  if (t.includes('estado'))    return '012';
  if (t.includes('chile'))     return '001';
  if (t.includes('bci') || t.includes('credito')) return '016';
  return s;
}

function limpiarNum(v) {
  if (v === null || v === undefined) return '';
  return v.toString().replace(/[\s.\-]/g, '');
}

function limpiarMonto(v) {
  if (v === null || v === undefined) return '0';
  if (typeof v === 'number') return Math.round(v).toString();
  return v.toString().trim().replace(/\./g, '').replace(/,/g, '').replace(/[^\d]/g, '');
}

// â”€â”€â”€ Detectar primera fila con datos reales â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function primeraFila(data) {
  for (let i = 0; i < data.length; i++) {
    const r = data[i];
    const llenas = r.slice(0, 8).filter(c => c !== null && c !== undefined && c.toString().trim() !== '').length;
    if (llenas >= 4) return i;
  }
  return 0;
}

// Detectar si una fila es "totales" (col B vacÃ­a o col A dice "total", col C tiene monto)
function esTotales(r) {
  const colA = (r[0] ?? '').toString().trim().toLowerCase();
  const colB = (r[1] ?? '').toString().trim();
  // Si col A dice "total" o similar, o si col B (nombre) estÃ¡ vacÃ­a pero col C tiene nÃºmero
  if (colA.includes('total') || colA.includes('suma')) return true;
  if (colB === '' && colA === '' && r[2] !== '' && r[2] !== undefined) return true;
  return false;
}

// â”€â”€â”€ Leer archivo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function leer(file) {
  if (!file) return;
  st('Leyendo archivoâ€¦', 'info');
  ['warnings','statsBox','prevWrap','txtPrev','genBtn'].forEach(id => {
    const el = document.getElementById(id);
    el.style.display = 'none';
  });

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const wb   = XLSX.read(e.target.result, { type: 'array', raw: true });
      const ws   = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', raw: true });

      const start = primeraFila(data);
      let rows = data.slice(start).filter(r =>
        r.slice(0, 8).some(c => c !== null && c !== undefined && c.toString().trim() !== '')
      );

      // Excluir fila de totales (normalmente la Ãºltima)
      rows = rows.filter(r => !esTotales(r));

      if (rows.length === 0) {
        st('No se encontraron datos. Revisa el archivo.', 'err');
        return;
      }

      let fixCount = 0;
      const warns  = [];

      filas = rows.map((r, idx) => {
        const rut         = (r[0] ?? '').toString().trim();
        const nombre      = (r[1] ?? '').toString().trim();
        const montoRaw    = limpiarMonto(r[2]);
        const medioRaw    = (r[3] ?? '').toString().trim();
        const medioFinal  = metodoPago(medioRaw);
        const codBancoRaw = r[4];
        const codBancoFin = codigoBanco(codBancoRaw);
        const tipoRaw     = (r[5] ?? '').toString().trim();
        const tipoCod     = tipoCuentaCodigo(tipoRaw);
        const numOrig     = (r[6] ?? '').toString().trim();
        const numClean    = limpiarNum(numOrig);
        const email       = (r[7] ?? '').toString().trim();

        // CodigoSucursal: '001' si banco es ItaÃº (039), sino vacÃ­o
        const sucursal = (codBancoFin === '039') ? '001' : '';

        const fixed = (tipoRaw !== tipoCod || numOrig !== numClean || medioRaw !== medioFinal);
        if (fixed) fixCount++;

        // Advertencias
        if (tipoRaw && !tipoCod) {
          warns.push(`Fila ${start + idx + 1}: tipo de cuenta no reconocido â†’ "${tipoRaw}"`);
        }
        if (!rut) warns.push(`Fila ${start + idx + 1}: RUT vacÃ­o`);
        if (!montoRaw || montoRaw === '0') warns.push(`Fila ${start + idx + 1}: monto cero o vacÃ­o`);

        return { rut, nombre, email, medioPago: medioFinal, codBanco: codBancoFin, tipoCuenta: tipoCod, numCuenta: numClean, monto: montoRaw, sucursal, fixed };
      });

      const total = filas.reduce((s, r) => s + (parseInt(r.monto, 10) || 0), 0);

      document.getElementById('sRows').textContent  = filas.length;
      document.getElementById('sTotal').textContent = '$' + total.toLocaleString('es-CL');
      document.getElementById('sFix').textContent   = fixCount;
      document.getElementById('statsBox').style.display = 'grid';

      if (warns.length) {
        const wEl = document.getElementById('warnings');
        wEl.innerHTML = 'âš  Verificar:<br>' + warns.join('<br>');
        wEl.style.display = 'block';
      }

      renderPreview();
      renderTxtPreview();

      st(`âœ“ ${filas.length} pagos cargados${fixCount ? ` Â· ${fixCount} campo(s) convertido(s) al formato banco` : ' Â· sin correcciones necesarias'}`, 'ok');
      document.getElementById('genBtn').style.display = 'block';

    } catch(err) {
      st('Error al leer el archivo: ' + err.message, 'err');
      console.error(err);
    }
  };
  reader.readAsArrayBuffer(file);
}

// â”€â”€â”€ Vista previa tabla â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPreview() {
  const wrap = document.getElementById('prevWrap');
  const tbl  = document.getElementById('prevTable');
  const hs   = ['RUT','Nombre','Monto','MÃ©todo Pago','Banco','Tipo Cta (banco)','NÂ° Cuenta','Email',''];

  let html = '<thead><tr>' + hs.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody>';
  filas.slice(0, 5).forEach(r => {
    html += `<tr>
      <td>${r.rut}</td>
      <td title="${r.nombre}">${r.nombre}</td>
      <td>$${parseInt(r.monto||0).toLocaleString('es-CL')}</td>
      <td>${r.medioPago}</td>
      <td>${r.codBanco}</td>
      <td>${tipoCuentaNombre(r.tipoCuenta)}</td>
      <td>${r.numCuenta}</td>
      <td title="${r.email}">${r.email}</td>
      <td class="${r.fixed ? 'tag-fix' : 'tag-ok'}">${r.fixed ? 'âœŽ' : 'âœ“'}</td>
    </tr>`;
  });
  if (filas.length > 5) {
    html += `<tr><td colspan="9" style="color:var(--muted);text-align:center;padding:.5rem">â€¦ y ${filas.length - 5} mÃ¡s</td></tr>`;
  }
  html += '</tbody>';
  tbl.innerHTML = html;
  wrap.style.display = 'block';
}

// â”€â”€â”€ Vista previa TXT (primeras 2 lÃ­neas) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTxtPreview() {
  const lines = construirTXT().split('\n').slice(0, 3);
  const el = document.getElementById('txtPrev');
  el.textContent = lines.join('\n');
  el.style.display = 'block';
}

// â”€â”€â”€ Construir contenido TXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function construirTXT() {
  const rutEmpresa  = document.getElementById('rutEmpresa').value.trim()   || '883971000';
  const cuentaCargo = document.getElementById('cuentaCargo').value.trim()  || '206388064';
  const tipoServ    = document.getElementById('tipoServicio').value;
  const descripcion = (document.getElementById('descripcion').value.trim() || 'PAGO NOMINA').substring(0, 40);
  const glosaOrig   = (document.getElementById('glosaOrig').value.trim()   || 'nomina').substring(0, 20);
  const glosaDesc   = (document.getElementById('glosaDesc').value.trim()   || 'nomina').substring(0, 20);

  const cantPagos  = filas.length;
  const montoTotal = filas.reduce((s, r) => s + (parseInt(r.monto, 10) || 0), 0);

  // â”€â”€ CABECERA â”€â”€
  // Formato: RutEmpresa,ContRegistros,SumRegistros,TipoServicio,MedioRespaldo,CtaCargo,Descripcion,GlosaOrigen,GlosaDestino
  const cabecera = [
    rutEmpresa,
    cantPagos,
    montoTotal,
    tipoServ,
    'CAT_CSH_CONTRACT_ACCOUNT',
    cuentaCargo,
    descripcion,
    glosaOrig,
    glosaDesc,
  ].join(',');

  // â”€â”€ REGISTROS â”€â”€
  // RutBenef, NombreBenef, Email, MetodoPago, CodBanco, TipoCuenta, NroCuenta,
  // FechaPago(vacÃ­o), Ref1(vacÃ­o), Ref2(vacÃ­o), Monto,
  // TipoCuentaCargo, NroCuentaCargo, CodigoSucursal,
  // ReferenciaCliente(vacÃ­o), GlosaPago(vacÃ­o), GlosaOrigen, GlosaDestino
  const registros = filas.map(r => [
    r.rut,
    r.nombre,
    r.email,
    r.medioPago,
    r.codBanco,
    r.tipoCuenta,
    r.numCuenta,
    '',           // FechaDePago (en blanco)
    '',           // Referencia1 (descontinuado)
    '',           // Referencia2 (descontinuado)
    r.monto,
    'CAT_CSH_CCTE',
    cuentaCargo,
    r.sucursal,
    '',           // ReferenciaCliente
    '',           // GlosaPago
    glosaOrig,
    glosaDesc,
  ].join(','));

  return [cabecera, ...registros].join('\n');
}

// â”€â”€â”€ Generar y descargar TXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generar() {
  const btn = document.getElementById('genBtn');
  btn.disabled = true;
  btn.textContent = 'Generandoâ€¦';

  try {
    const contenido = construirTXT();

    const hoy  = new Date();
    const dd   = String(hoy.getDate()).padStart(2,'0');
    const mm   = String(hoy.getMonth()+1).padStart(2,'0');
    const aaaa = hoy.getFullYear();
    const nombre = `nomina_itau_${dd}${mm}${aaaa}.txt`;

    // Descargar
    const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = nombre;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    st(`âœ… Descargado: ${nombre} â€” listo para subir al portal ItaÃº`, 'ok');

  } catch(err) {
    st('Error generando el archivo: ' + err.message, 'err');
  }

  btn.disabled = false;
  btn.textContent = 'â¬‡ GENERAR ARCHIVO TXT PARA BANCO';
}
</script>
</body>
</html>
